<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Contribution graph</title>
        <style type="text/css">
        <!--
            body, html {
                margin : 10px;
            }
            .spacer10 { height: 10px; width: 100%; font-size: 0; margin: 0; padding: 0; border: 0; display: block; }
            #karma div, #days div, #months div {
                position: relative;
                float: left;
                display: block;
                color: #767676;
                font-size: 14px;
                border: 1px;
                padding: 0;
                margin: 1px;
                vertical-align: middle;
                height: 16px;
            }
            #karma div {
                width: 16px;
                background-color: #EEEEEE;
                text-align: center;
            }
            #days div {
                width: 36px;
                background-color: #FFFFFF;
                text-align: left;
                clear:left;
            }
            #months div {
                background-color: #FFFFFF;
                text-align: center;
            }
            #legend {
                position: absolute;
                top: 190px;
                background-color: #FFFFFF;
                font-size: 14px;
                color: #767676;
            }
            #legend div {
                display:block;
                margin: 1px;
                height: 16px;
            }
        -->
        </style>
    </head>

    <body>
        <div id="chart">
            <div id="months"></div>
            <div class="spacer10"></div>
            <br />
            <div id="days" style="float:left"><div></div><div>Mon</div><div></div><div>Wed</div><div></div><div>Fri</div></div>
            <div id="karma" style="float:left" data-name="Abhijeet" data-checkins="10 2016/01/01 1 2016/01/31 10 2016/02/01 1 2016/02/29 10 2016/03/01 1 2016/03/31 10 2016/04/01 1 2016/04/30 10 2016/05/01 1 2016/05/31 10 2016/06/01 1 2016/06/30 10 2016/07/01 1 2016/07/31 10 2016/08/01 1 2016/08/31 10 2016/09/01 1 2016/09/30 10 2016/10/01 1 2016/10/31 10 2016/11/01 1 2016/11/30 10 2016/12/01 1 2016/12/31 5 2017/01/05"> </div>
            <div style="float:left"><h1 id="username" style="color:green"></h1></div>
            <br><br>
            <div id="legend"><div style="float:left;width:36px">Less</div>
                <div style="float:left;width:16px;background-color:#EEEEEE;box-shadow: inset 0 0 1px 1px #CCCCCC"></div>
                <div style="float:left;width:16px;background-color:#d6e685;box-shadow: inset 0 0 1px 1px #8cc665"></div>
                <div style="float:left;width:16px;background-color:#8cc665;box-shadow: inset 0 0 1px 1px #44a340"></div>
                <div style="float:left;width:16px;background-color:#44a340;box-shadow: inset 0 0 1px 1px #1e6823"></div>
                <div style="float:left;width:16px;background-color:#1e6823;box-shadow: inset 0 0 1px 1px #005800"></div>
                <div style="float:left;width:36px;text-align:right">More</div></div>
        </div>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.16.2/lodash.min.js"></script>
        <!-- script type="text/javascript" src="html2canvas.js"></script -->
        <script>
            Number.prototype.format = function(n, x) {
                var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\.' : '$') + ')';
                return this.toFixed(Math.max(0, ~~n)).replace(new RegExp(re, 'g'), '$&,');
            };
            var colors   = ['#FFFFFF', '#EEEEEE', '#d6e685', '#8cc665', '#44a340', '#1e6823'];
            var borders  = ['#FFFFFF', '#CCCCCC', '#8cc665', '#44a340', '#1e6823', '#005800'];
            var checkins = $('#karma').data("checkins").split(" ");
            var username = $('#karma').data("name");
            var total = 0;
            for (var i = 0; i < checkins.length; i+=2) {
                total += parseInt(checkins[i]);
            }
            $('#username').html('&nbsp;&nbsp;&nbsp;' + username + "&nbsp;<span style=\"font-size:14px;color:gray\">" + total.format() + " contributions</span>");
            var from     = new Date(checkins[1]);
            if (from.getDate() != 1) {
                var month = from.getMonth() + 1;
                checkins.unshift("0", from.getFullYear() + "/" + month + "/01");
                from = new Date(checkins[1]);
            }
            //console.log("from date = " + from);
            var to      = new Date(checkins[checkins.length-1]);
            const msDay = 60 * 60 * 24 * 1000;
            var n       = Math.floor(to - from) / msDay;
            n          += from.getDay() + 1;
            var adj_n   = (n < 28) ? 28 : n;
            var cols    = Math.ceil(adj_n/7);
            //console.log("cols = " + cols);
            // Map the datapoints to the div-numbers
            var mapped_data = {};
            var last_entry  = 0;
            // Calculate offsets from the first top-left square
            // from.getDay() is the offset of the 1st day of the 1st month
            for (var c = 1; c < checkins.length; c+=2) {
                var d                   = new Date(checkins[c]);
                var diff                = Math.floor(d - from) / msDay + from.getDay();
                var col                 = Math.floor(diff / 7);
                var row                 = diff % 7;
                last_entry              = row*cols + col;
                mapped_data[last_entry] = checkins[c-1];
                //console.log("Processed date = " + d);
                //console.log("i = ", row*cols + col, " #c = ", checkins[c-1]);
            }
            $('#karma').empty();
            var last_day = to.getDay();
            var divs = "";
            for (var i = 0; i < cols*7; i++) {
                var sty   = "style=\"";
                var color = 1;
                if ((i+1)%cols == 0) {
                    //console.log(last_day);
                    if ((i+1)/cols > last_day) {
                        color = 0; // Show white boxes beyond the last day of the checkin
                    }
                }
                if (i % cols == 0) {
                    sty += "clear:left;"
                }
                if (_.has(mapped_data, i)) {
                    var val   = parseInt(mapped_data[i]);
                    // Choose these values as per the data
                    if (val <= 0) {
                        color = 1;
                    } else if (val <= 5) {
                        color = 2;
                    } else if (val <= 35) {
                        color = 3;
                    } else if (val <= 75) {
                        color = 4;
                    } else {
                        color = 5;
                    }
                }
                //color = Math.floor((Math.random() * 5) + 1);
                sty  += "background-color:" + colors[color] + ";";
                if (color > 1)
                    sty  += "box-shadow: inset 0 0 1px 1px " + borders[color] + ";";
                sty  += "\"";
                divs += "<div " + sty + "></div>";
            }
            $('#karma').html(divs);
            var from_m = from.getMonth();
            var to_m   = to.getMonth();
            $('#months').empty();
            var m                          = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            var days_in_m                  = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            var month_divs                 = "<div style=\"width:36px\"></div>";
            var cols_for_this_month        = Math.ceil((from.getDay() + days_in_m[from.getMonth()])/7);
            var month_col_width            = 16 * cols_for_this_month + 2 * (cols_for_this_month - 1);
            var overlaps_with_prev         = (0 == from.getDay()) ? false : true;
            var days_overlapping_with_next = (7 - (7 * cols_for_this_month - (from.getDay() + days_in_m[from.getMonth()]))) % 7;
            //console.log("ovl = ", days_overlapping_with_next);
            var sty = "style=\"";
            sty    += "width:" + month_col_width.toString() + "px;";
            if (overlaps_with_prev) {
                sty += "margin-left:-16px";
            }
            sty += "\"";
            month_divs += "<div " + sty + ">" + m[from_m] + "</div>";
            var j_max = Math.floor(cols/4.2); // FIXME 4.3 = (366/12) / 7
            var i     = from_m;
            for (var j = 1; j < j_max; j++) {
                i++;
                i = i % 12;
                cols_for_this_month        = Math.ceil((days_overlapping_with_next + days_in_m[i])/7);
                month_col_width            = 16 * cols_for_this_month + 2 * (cols_for_this_month - 1);
                overlaps_with_prev         = (0 == days_overlapping_with_next) ? false : true;
                days_overlapping_with_next = (7 - (7 * cols_for_this_month - (days_overlapping_with_next + days_in_m[i]))) % 7;
                //console.log("m = ", m[i]);
                //console.log("cols/m = ", cols_for_this_month);
                //console.log("ovl = ", days_overlapping_with_next);
                sty  = "style=\"";
                sty += "width:" + month_col_width.toString() + "px;";
                if (overlaps_with_prev) {
                    sty += "margin-left:-16px";
                }
                sty += "\"";
                month_divs += "<div " + sty + ">" + m[i] + "</div>";
            }
            $('#months').html(month_divs);
/*
            html2canvas(document.body, {
                onrendered: function(canvas) {
                    document.body.appendChild(canvas);
                }
            });
*/
        </script>
    </body>
</html>
